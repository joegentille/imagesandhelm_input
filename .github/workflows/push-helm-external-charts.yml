name: Push external Helm Charts to GHCR
on:
  workflow_dispatch:
    inputs:
      repository_url:
        description: 'Helm repository URL (e.g., https://charts.bitnami.com/bitnami)'
        required: true
        type: string
      repository_name:
        description: 'Helm repository name (e.g., bitnami, stable)'
        required: true
        type: string
      charts_filter:
        description: 'Charts to mirror (comma-separated, empty = all). Example: apache,wordpress,redis'
        required: false
        type: string
env:
  REGISTRY: ghcr.io
jobs:
  mirror-helm-charts:
    runs-on: windows-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
      
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup and discover charts
        id: discover
        shell: pwsh
        run: |
          $repoUrl = "${{ github.event.inputs.repository_url }}"
          $repoName = "${{ github.event.inputs.repository_name }}"
          $chartsFilter = "${{ github.event.inputs.charts_filter }}"
          
          Write-Host "Adding Helm repository: $repoName"
          helm repo add $repoName $repoUrl --force-update
          helm repo update
          
          Write-Host "`nSearching for charts in repository..."
          $charts = helm search repo $repoName --output json | ConvertFrom-Json
          
          if ($null -eq $charts -or $charts.Count -eq 0) {
            Write-Error "No charts found in repository"
            exit 1
          }
          
          # Filter charts if specified
          $selectedCharts = @()
          
          if (-not [string]::IsNullOrWhiteSpace($chartsFilter)) {
            $filterList = $chartsFilter -split ',' | ForEach-Object { $_.Trim().ToLower() }
            $selectedCharts = $charts | Where-Object { $filterList -contains $_.name.split('/')[-1].ToLower() }
            Write-Host "Found $($selectedCharts.Count) matching charts"
          } else {
            $selectedCharts = $charts
            Write-Host "Found $($selectedCharts.Count) charts total"
          }
          
          $chartsJson = $selectedCharts | ConvertTo-Json -Compress
          Add-Content -Path $env:GITHUB_OUTPUT -Value "charts=$chartsJson"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "chart_count=$($selectedCharts.Count)"
      - name: Mirror charts to GHCR
        shell: pwsh
        run: |
          $charts = ConvertFrom-Json -InputObject '${{ steps.discover.outputs.charts }}'
          $packageDir = "$env:TEMP\helm-packages"
          $owner = "${{ github.repository_owner }}".ToLower()
          
          New-Item -ItemType Directory -Path $packageDir -Force | Out-Null
          
          $totalCharts = if ($charts -is [array]) { $charts.Count } else { 1 }
          Write-Host "Processing $totalCharts charts...`n"
          
          foreach ($chart in $charts) {
            $chartName = $chart.name
            $chartVersion = $chart.version
            $chartDesc = $chart.description
            
            Write-Host "════════════════════════════════════════"
            Write-Host "Mirroring: $chartName - $chartVersion"
            Write-Host "════════════════════════════════════════"
            
            try {
              # Extract chart name
              $simpleName = ($chartName -split '/')[-1]
              $simpleName = $simpleName.ToLower()
              
              # Pull chart
              Write-Host "Downloading chart..."
              helm pull $chartName --version $chartVersion --destination $packageDir 2>&1 | Out-Host
              
              if ($LASTEXITCODE -ne 0) {
                throw "Failed to download chart"
              }
              
              $chartFile = Get-ChildItem -Path $packageDir -Filter "*$simpleName*$chartVersion*.tgz" | Select-Object -First 1
              
              if (-not $chartFile) {
                throw "Chart file not found after download"
              }
              
              # Push to GHCR
              $targetRegistry = "oci://${{ env.REGISTRY }}/$owner"
              Write-Host "Pushing to GHCR: ${{ env.REGISTRY }}/$owner/$simpleName"
              helm push $chartFile.FullName $targetRegistry 2>&1 | Out-Host
              
              if ($LASTEXITCODE -ne 0) {
                throw "Failed to push chart to GHCR"
              }
              
              # Cleanup
              Remove-Item -Path $chartFile.FullName -Force
              
              $registry = "${{ env.REGISTRY }}"
              Write-Host "Success: $simpleName`:$chartVersion`n"
              
            } catch {
              $errorMsg = "$chartName - $_"
              Write-Host "✗ Error: $errorMsg`n"
            }
          }
          
