name: Push Helm Charts to GHCR - Local Paths
on:
  workflow_dispatch:
    inputs:
      chart_paths:
        description: 'Path to Helm Charts, comma separated (Ex: ./charts/app1,./charts/app2)'
        required: true
        type: string
env:
  REGISTRY: ghcr.io
jobs:
  push-helm-charts:
    runs-on: windows-latest
    
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
      
      - name: Verify Helm installation
        shell: pwsh
        run: |
          Write-Host "Helm version:"
          helm version
          Write-Host ""
          Write-Host "Helm plugin list:"
          helm plugin list 2>&1 | Out-Host
      
      - name: Parse chart paths
        id: paths
        shell: pwsh
        run: |
          $chartPaths = "${{ github.event.inputs.chart_paths }}" -split ',' | ForEach-Object { $_.Trim() }
          $validCharts = @()
          
          foreach ($path in $chartPaths) {
            if (Test-Path -Path $path -PathType Container) {
              $validCharts += $path
              Write-Host "✓ Chart found: $path"
            } else {
              Write-Host "✗ Chart not found: $path"
            }
          }
          
          if ($validCharts.Count -eq 0) {
            Write-Host "::error::No valid chart paths provided"
            exit 1
          }
          
          $chartsJson = $validCharts | ConvertTo-Json -Compress
          Add-Content -Path $env:GITHUB_OUTPUT -Value "charts=$chartsJson"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "chart_count=$($validCharts.Count)"
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Process and push helm charts
        shell: pwsh
        run: |
          $charts = ConvertFrom-Json -InputObject '${{ steps.paths.outputs.charts }}'
          $packageDir = "$env:TEMP\helm-packages"
          $successLog = "$env:TEMP\success-charts.txt"
          $errorLog = "$env:TEMP\error-charts.txt"
          
          # Clean logs - Initialize as empty files
          @() | Set-Content -Path $successLog -Force
          @() | Set-Content -Path $errorLog -Force
          
          # Create package directory
          if (-not (Test-Path -Path $packageDir)) {
            New-Item -ItemType Directory -Path $packageDir -Force | Out-Null
          }
          
          $totalCharts = $charts.Count
          if ($totalCharts -eq $null) { $totalCharts = 1 }
          
          foreach ($chartPath in $charts) {
            if ($null -eq $chartPath) { continue }
            
            Write-Host "`n════════════════════════════════════════"
            Write-Host "Processing: $chartPath"
            Write-Host "════════════════════════════════════════`n"
            
            # Validate chart directory exists
            if (-not (Test-Path -Path $chartPath -PathType Container)) {
              $errorMsg = "FAILED - Chart directory not found: $chartPath"
              Write-Host $errorMsg
              Add-Content -Path $errorLog -Value $errorMsg
              continue
            }
            
            # Get chart metadata
            $chartYamlPath = Join-Path -Path $chartPath -ChildPath "Chart.yaml"
            if (-not (Test-Path -Path $chartYamlPath)) {
              $errorMsg = "FAILED - Chart.yaml not found in $chartPath"
              Write-Host $errorMsg
              Add-Content -Path $errorLog -Value $errorMsg
              continue
            }
            
            # Parse Chart.yaml
            $chartName = ""
            $chartVersion = ""
            $description = ""
            
            Get-Content -Path $chartYamlPath | ForEach-Object {
              if ($_ -match '^\s*name:\s*(.+)$') {
                $chartName = $matches[1].Trim()
              }
              if ($_ -match '^\s*version:\s*(.+)$') {
                $chartVersion = $matches[1].Trim()
              }
              if ($_ -match '^\s*description:\s*(.+)$') {
                $description = $matches[1].Trim()
              }
            }
            
            if ([string]::IsNullOrWhiteSpace($chartName) -or [string]::IsNullOrWhiteSpace($chartVersion)) {
              $errorMsg = "FAILED - Invalid Chart.yaml: missing name or version in $chartPath"
              Write-Host $errorMsg
              Add-Content -Path $errorLog -Value $errorMsg
              continue
            }
            
            Write-Host "Chart: $chartName"
            Write-Host "Version: $chartVersion"
            Write-Host "Description: $description`n"
            
            # Validate Helm chart
            Write-Host "Validating Helm Chart..."
            helm lint $chartPath 2>&1 | Out-Host
            
            if ($LASTEXITCODE -ne 0) {
              $errorMsg = "FAILED - Helm lint error for $chartPath"
              Write-Host $errorMsg
              Add-Content -Path $errorLog -Value $errorMsg
              continue
            }
            
            # Package Helm chart
            Write-Host "Packaging Helm Chart..."
            helm package $chartPath --version $chartVersion --destination $packageDir 2>&1 | Out-Host
            
            if ($LASTEXITCODE -ne 0) {
              $errorMsg = "FAILED to package: $($chartName):$chartVersion"
              Write-Host $errorMsg
              Add-Content -Path $errorLog -Value $errorMsg
              continue
            }
            
            $chartFile = Join-Path -Path $packageDir -ChildPath "$chartName-$chartVersion.tgz"
            
            if (-not (Test-Path -Path $chartFile)) {
              $errorMsg = "FAILED - Chart package not found: $chartFile"
              Write-Host $errorMsg
              Add-Content -Path $errorLog -Value $errorMsg
              continue
            }
            
            # Push to GHCR
            $targetChart = "${{ env.REGISTRY }}/${{ github.repository_owner }}/$chartName"
            
            Write-Host "Pushing to GHCR..."
            helm push $chartFile "oci://${{ env.REGISTRY }}/${{ github.repository_owner }}" 2>&1 | Out-Host
            
            if ($LASTEXITCODE -ne 0) {
              $errorMsg = "FAILED to push: $($targetChart):$chartVersion"
              Write-Host $errorMsg
              Add-Content -Path $errorLog -Value $errorMsg
              Remove-Item -Path $chartFile -Force -ErrorAction SilentlyContinue
              continue
            }
            
            # Cleanup
            Remove-Item -Path $chartFile -Force -ErrorAction SilentlyContinue
            
            $successMsg = "$chartName|$($targetChart):$chartVersion|$description"
            Write-Host "Done: $($targetChart):$chartVersion`n"
            Add-Content -Path $successLog -Value $successMsg
          }
          
          # Create summary files for next step
          if (Test-Path -Path $successLog) {
            Copy-Item -Path $successLog -Destination "$env:TEMP\success-charts-summary.txt" -Force
          }
          
          if (Test-Path -Path $errorLog) {
            Copy-Item -Path $errorLog -Destination "$env:TEMP\error-charts-summary.txt" -Force
          }
      - name: Create job summary
        if: always()
        shell: pwsh
        run: |
          $successLog = "$env:TEMP\success-charts-summary.txt"
          $errorLog = "$env:TEMP\error-charts-summary.txt"
          $chartCount = ${{ steps.paths.outputs.chart_count }}
          
          $summaryFile = $env:GITHUB_STEP_SUMMARY
          
          # Count successes and failures
          $successCount = 0
          $errorCount = 0
          
          if ((Test-Path -Path $successLog) -and ((Get-Item $successLog).Length -gt 0)) {
            $successCount = @(Get-Content -Path $successLog | Where-Object { $_ -and $_.Trim() }).Count
          }
          
          if ((Test-Path -Path $errorLog) -and ((Get-Item $errorLog).Length -gt 0)) {
            $errorCount = @(Get-Content -Path $errorLog | Where-Object { $_ -and $_.Trim() }).Count
          }
          
          # Write summary
          if ($successCount -gt 0) {
            Add-Content -Path $summaryFile -Value "# Helm Charts Pushed Successfully"
          } else {
            Add-Content -Path $summaryFile -Value "# Helm Charts Push Failed"
          }
          
          Add-Content -Path $summaryFile -Value ""
          
          if ($successCount -gt 0) {
            Add-Content -Path $summaryFile -Value "## Helm Charts Pushed ($successCount/$chartCount):"
            Add-Content -Path $summaryFile -Value ""
            
            if (Test-Path -Path $successLog) {
              Get-Content -Path $successLog | Where-Object { $_ -and $_.Trim() } | ForEach-Object {
                $parts = $_ -split '\|'
                $name = $parts[0].Trim()
                $target = if ($parts.Count -gt 1) { $parts[1].Trim() } else { "" }
                $description = if ($parts.Count -gt 2) { $parts[2].Trim() } else { "" }
                
                Add-Content -Path $summaryFile -Value "- OK: $name => $target"
                if ($description) {
                  Add-Content -Path $summaryFile -Value "  Description: $description"
                }
              }
            }
            
            Add-Content -Path $summaryFile -Value ""
          }
          
          if ($errorCount -gt 0) {
            Add-Content -Path $summaryFile -Value "## Helm Charts Failed ($errorCount/$chartCount):"
            Add-Content -Path $summaryFile -Value ""
            
            if (Test-Path -Path $errorLog) {
              Get-Content -Path $errorLog | Where-Object { $_ -and $_.Trim() } | ForEach-Object {
                Add-Content -Path $summaryFile -Value "- Error: $_"
              }
            }
            
            Add-Content -Path $summaryFile -Value ""
          }
