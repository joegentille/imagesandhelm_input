name: Push Docker Images to GHCR

on:
  workflow_dispatch:
    inputs:
      images:
        description: 'List of Docker images to push (comma-separated, e.g. ubuntu:resolute-20260108,nginx:latest)'
        required: true
        type: string
        default: 'ubuntu:22.04,nginx:latest'

env:
  REGISTRY: ghcr.io

jobs:
  push-to-ghcr:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load and validate images
        id: config
        shell: pwsh
        run: |
          # Parse the input images list (comma-separated)
          $IMAGES_INPUT = "${{ github.event.inputs.images }}"
          
          # Convert comma-separated input to JSON array
          $images = @()
          $imageCount = 0
          
          # Process images comma-separated
          $imageList = $IMAGES_INPUT -split ','
          foreach ($image in $imageList) {
            $image = $image.Trim()
            
            # Skip empty entries
            if ([string]::IsNullOrWhiteSpace($image)) {
              continue
            }
            
            # Extract repository_name and tag from source_image
            if ($image -contains ':') {
              $parts = $image -split ':'
              $REPO_NAME = $parts[0]
              $TAG = $parts[1]
            } else {
              # Image without tag (e.g., nginx), default to 'latest'
              $REPO_NAME = $image
              $TAG = 'latest'
            }
            
            # Build object for this image
            $imgObject = @{
              source_image = $image
              repository_name = $REPO_NAME
              tag = $TAG
            }
            
            $images += $imgObject
            $imageCount++
            Write-Output "âœ… Parsed: $image (repo: $REPO_NAME, tag: $TAG)"
          }
          
          # Convert to JSON
          $matrix = $images | ConvertTo-Json -Compress
          
          # Output for next steps
          if ($imageCount -gt 0) {
            "matrix=$matrix" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "image_count=$imageCount" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "has_images=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            Write-Output "âœ… Found $imageCount valid image(s) to process"
          }
          else {
            "has_images=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "image_count=0" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            Write-Output "âš ï¸  No valid images found in the input"
          }

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Process images
        if: steps.config.outputs.has_images == 'true'
        shell: pwsh
        run: |
          $MATRIX = '${{ steps.config.outputs.matrix }}'
          $TRIVY_REPORT = "/tmp/trivy-report.txt"
          $SUCCESS_LOG = "/tmp/success-images.txt"
          $ERROR_LOG = "/tmp/error-images.txt"
          
          # Clear files
          "" | Out-File -FilePath $TRIVY_REPORT -Encoding utf8
          "" | Out-File -FilePath $SUCCESS_LOG -Encoding utf8
          "" | Out-File -FilePath $ERROR_LOG -Encoding utf8
          
          # Parse the matrix JSON
          $images = $MATRIX | ConvertFrom-Json
          
          foreach ($img in $images) {
            $SOURCE_IMAGE = $img.source_image
            $REPOSITORY_NAME = $img.repository_name
            $TAG = $img.tag
            $TARGET_IMAGE = "${{ env.REGISTRY }}/${{ github.repository_owner }}/${REPOSITORY_NAME}"
            
            Write-Output ""
            Write-Output "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            Write-Output "Processing: $SOURCE_IMAGE"
            Write-Output "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            # Pull image
            Write-Output "Pulling source image..."
            $pullResult = docker pull "$SOURCE_IMAGE" --quiet 2>&1
            if ($LASTEXITCODE -ne 0) {
              "FAILED to pull: $SOURCE_IMAGE" | Tee-Object -FilePath $ERROR_LOG -Append | Write-Output
              continue
            }
            
            # Scan with Trivy
            Write-Output "ðŸ” Scanning for vulnerabilities with Trivy..."
            "### $SOURCE_IMAGE" | Out-File -FilePath $TRIVY_REPORT -Encoding utf8 -Append
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock `
              aquasec/trivy:latest image --severity HIGH,CRITICAL `
              --format table "$SOURCE_IMAGE" | Out-File -FilePath $TRIVY_REPORT -Encoding utf8 -Append
            "" | Out-File -FilePath $TRIVY_REPORT -Encoding utf8 -Append
            
            # Tag images
            Write-Output "Tagging image..."
            $tagResult = docker tag "$SOURCE_IMAGE" "${TARGET_IMAGE}:${TAG}" 2>&1
            if ($LASTEXITCODE -ne 0) {
              "FAILED to tag: $SOURCE_IMAGE â†’ ${TARGET_IMAGE}:${TAG}" | Tee-Object -FilePath $ERROR_LOG -Append | Write-Output
              docker rmi "$SOURCE_IMAGE" 2>$null
              continue
            }
            
            # Push images
            Write-Output "Pushing to GHCR..."
            $pushResult = docker push "${TARGET_IMAGE}:${TAG}" 2>&1
            if ($LASTEXITCODE -ne 0) {
              "FAILED to push: ${TARGET_IMAGE}:${TAG}" | Tee-Object -FilePath $ERROR_LOG -Append | Write-Output
              docker rmi "$SOURCE_IMAGE" "${TARGET_IMAGE}:${TAG}" "${TARGET_IMAGE}:latest" 2>$null
              continue
            }
            
            # Cleanup
            Write-Output "Cleaning up..."
            docker rmi "$SOURCE_IMAGE" "${TARGET_IMAGE}:${TAG}" "${TARGET_IMAGE}:latest" 2>$null
            
            Write-Output "Done: $SOURCE_IMAGE â†’ ${TARGET_IMAGE}:${TAG}"
            "$SOURCE_IMAGE|${TARGET_IMAGE}:${TAG}" | Out-File -FilePath $SUCCESS_LOG -Encoding utf8 -Append
          }
          
          # Save reports for summary
          Copy-Item $TRIVY_REPORT /tmp/trivy-summary.txt -Force
          if (Test-Path $SUCCESS_LOG) {
            if ((Get-Item $SUCCESS_LOG).Length -gt 0) {
              Copy-Item $SUCCESS_LOG /tmp/success-summary.txt -Force
            }
          }
          if (Test-Path $ERROR_LOG) {
            if ((Get-Item $ERROR_LOG).Length -gt 0) {
              Copy-Item $ERROR_LOG /tmp/error-summary.txt -Force
            }
          }

      - name: Create job summary
        if: always()
        shell: pwsh
        run: |
          $TRIVY_REPORT = "/tmp/trivy-summary.txt"
          $SUCCESS_LOG = "/tmp/success-summary.txt"
          $ERROR_LOG = "/tmp/error-summary.txt"
          $IMAGE_COUNT = ${{ steps.config.outputs.image_count }}
          
          if ($IMAGE_COUNT -eq 0) {
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "# No Images to Process"
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "Didn't find any valid images in the input provided."
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "**Please provide a list of images (comma-separated):**"
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '- `ubuntu:resolute-20260108,nginx:latest`'
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '- `redis:7.0-alpine,postgres:15`'
          } else {
            # Count successful and failed images
            $SUCCESS_COUNT = 0
            $ERROR_COUNT = 0
            
            if (Test-Path $SUCCESS_LOG) {
              $successContent = Get-Content $SUCCESS_LOG
              if ($null -ne $successContent) {
                $SUCCESS_COUNT = @($successContent).Count
              }
            }
            
            if (Test-Path $ERROR_LOG) {
              $errorContent = Get-Content $ERROR_LOG
              if ($null -ne $errorContent) {
                $ERROR_COUNT = @($errorContent).Count
              }
            }
            
            if ($SUCCESS_COUNT -gt 0) {
              Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "# Linux Images Processed Successfully"
            }
            else {
              Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "# Linux Images Processing Failed"
            }
            
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
            
            if ($SUCCESS_COUNT -gt 0) {
              Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Images Pushed Successfully ($SUCCESS_COUNT/$IMAGE_COUNT):"
              Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
              
              if (Test-Path $SUCCESS_LOG) {
                $successLines = Get-Content $SUCCESS_LOG
                foreach ($line in $successLines) {
                  $parts = $line -split '\|'
                  if ($parts.Length -eq 2) {
                    Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ('- `' + $($parts[0]) + '` â†’ `' + $($parts[1]) + '`')
                  }
                }
              }
              
              Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
            }
            
            if ($ERROR_COUNT -gt 0) {
              Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Images Failed to Process ($ERROR_COUNT/$IMAGE_COUNT):"
              Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
              
              if (Test-Path $ERROR_LOG) {
                $errorLines = Get-Content $ERROR_LOG
                foreach ($line in $errorLines) {
                  Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- $line"
                }
              }
              
              Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
            }
            
            if ($SUCCESS_COUNT -gt 0) {
              Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Security Scan Report (Trivy - Successful Images Only):"
              Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
              Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '```'
              
              if (Test-Path $TRIVY_REPORT) {
                $trivyContent = Get-Content $TRIVY_REPORT -Raw
                if (-not [string]::IsNullOrWhiteSpace($trivyContent)) {
                  Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $trivyContent
                }
                else {
                  Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "No vulnerabilities found or scan not executed"
                }
              }
              else {
                Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "No vulnerabilities found or scan not executed"
              }
              
              Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value '```'
            }
          }
          
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "**Platform:** Linux | **Runner:** ubuntu-latest | **Input Source:** Simple Image List"
